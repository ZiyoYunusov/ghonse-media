<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 40px;
            line-height: 1.6;
        }
        .step {
            background: #f5f5f5;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
        }
        code {
            background: #333;
            color: #fff;
            padding: 10px;
            display: block;
            margin: 10px 0;
            border-radius: 5px;
        }
        button {
            background: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <h1>üî• –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò</h1>
    
    <div class="step">
        <h2>–®–∞–≥ 1: –û—á–∏—Å—Ç–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –±—Ä–∞—É–∑–µ—Ä–∞</h2>
        <p>–ù–∞–∂–º–∏—Ç–µ F12 ‚Üí Application ‚Üí Storage ‚Üí Clear All</p>
        <button onclick="clearAllData()">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ</button>
    </div>
    
    <div class="step">
        <h2>–®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é Firebase</h2>
        <p>–ó–∞–π–¥–∏—Ç–µ –≤ <a href="https://console.firebase.google.com" target="_blank">Firebase Console</a> –∏ —É–±–µ–¥–∏—Ç–µ—Å—å:</p>
        <ol>
            <li>–ü—Ä–æ–µ–∫—Ç —Å–æ–∑–¥–∞–Ω</li>
            <li>Authentication –≤–∫–ª—é—á–µ–Ω (Email/Password)</li>
            <li>Firestore Database —Å–æ–∑–¥–∞–Ω–∞</li>
        </ol>
    </div>
    
    <div class="step">
        <h2>–®–∞–≥ 3: –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è firebase.js</h2>
        <p>–ó–∞–º–µ–Ω–∏—Ç–µ firebase.js –Ω–∞ —ç—Ç–æ—Ç –∫–æ–¥:</p>
        <code>
// firebase.js - –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø
const firebaseConfig = {
    apiKey: "AIzaSyBKCcDda45gUbsr-iNdMPQq_Bz7XE5evTQ",
    authDomain: "ghonse-media-site.firebaseapp.com",
    projectId: "ghonse-media-site",
    storageBucket: "ghonse-media-site.firebasestorage.app",
    messagingSenderId: "334804323154",
    appId: "1:334804323154:web:5f0784093e1630c798888b"
};

// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
let auth, db;

// –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –ª–∏ Firebase
if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
}

auth = firebase.auth();
db = firebase.firestore();

// –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏
auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL)
    .then(() => {
        console.log("‚úÖ Firebase –Ω–∞—Å—Ç—Ä–æ–µ–Ω, —Å–µ—Å—Å–∏—è —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è");
    })
    .catch((error) => {
        console.error("‚ùå –û—à–∏–±–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Firebase:", error);
    });

// –ö–ª–∞—Å—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π
window.FirebaseAuthService = {
    
    // –í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É
    async loginUser(email, password) {
        try {
            console.log("üîê –ü–æ–ø—ã—Ç–∫–∞ –≤—Ö–æ–¥–∞:", email);
            
            if (!email || !password) {
                return { success: false, error: "–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è" };
            }
            
            if (!this.isValidEmail(email)) {
                return { success: false, error: "–í–≤–µ–¥–∏—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π email" };
            }
            
            const userCredential = await auth.signInWithEmailAndPassword(email, password);
            const user = userCredential.user;
            
            console.log("‚úÖ –£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥:", user.uid);
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            localStorage.setItem('currentUser', JSON.stringify({
                uid: user.uid,
                email: user.email
            }));
            
            return { success: true, user: user };
            
        } catch (error) {
            console.error("‚ùå –û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞:", error.code, error.message);
            
            let errorMessage = "–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞";
            switch(error.code) {
                case 'auth/user-not-found':
                    errorMessage = "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω";
                    break;
                case 'auth/wrong-password':
                    errorMessage = "–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å";
                    break;
                case 'auth/invalid-email':
                    errorMessage = "–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π email";
                    break;
                case 'auth/too-many-requests':
                    errorMessage = "–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ø–æ–ø—ã—Ç–æ–∫. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ";
                    break;
                default:
                    errorMessage = error.message;
            }
            
            return { success: false, error: errorMessage };
        }
    },
    
    // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
    async registerUser(userData) {
        try {
            console.log("üìù –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è:", userData.email);
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö
            if (!userData.email || !this.isValidEmail(userData.email)) {
                return { success: false, error: "–í–≤–µ–¥–∏—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π email" };
            }
            
            if (!userData.password || userData.password.length < 6) {
                return { success: false, error: "–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤" };
            }
            
            if (userData.password !== userData.confirmPassword) {
                return { success: false, error: "–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç" };
            }
            
            // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ Firebase Auth
            const userCredential = await auth.createUserWithEmailAndPassword(
                userData.email, 
                userData.password
            );
            
            const user = userCredential.user;
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ Firestore
            await db.collection('users').doc(user.uid).set({
                uid: user.uid,
                email: userData.email,
                firstName: userData.firstName || '',
                lastName: userData.lastName || '',
                age: parseInt(userData.age) || 0,
                username: userData.username || '',
                role: 'user',
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                isOnline: true
            });
            
            console.log("‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω:", user.uid);
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
            localStorage.setItem('currentUser', JSON.stringify({
                uid: user.uid,
                email: user.email
            }));
            
            return { success: true, user: user };
            
        } catch (error) {
            console.error("‚ùå –û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:", error.code, error.message);
            
            let errorMessage = "–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏";
            switch(error.code) {
                case 'auth/email-already-in-use':
                    errorMessage = "–≠—Ç–æ—Ç email —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è";
                    break;
                case 'auth/invalid-email':
                    errorMessage = "–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π email";
                    break;
                case 'auth/weak-password':
                    errorMessage = "–ü–∞—Ä–æ–ª—å —Å–ª–∏—à–∫–æ–º –ø—Ä–æ—Å—Ç–æ–π";
                    break;
                default:
                    errorMessage = error.message;
            }
            
            return { success: false, error: errorMessage };
        }
    },
    
    // –í—ã—Ö–æ–¥
    async logout() {
        try {
            const user = auth.currentUser;
            if (user) {
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤ Firestore
                await db.collection('users').doc(user.uid).update({
                    isOnline: false,
                    lastLogout: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
            
            await auth.signOut();
            localStorage.removeItem('currentUser');
            console.log("‚úÖ –í—ã—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω");
            
            return { success: true };
            
        } catch (error) {
            console.error("‚ùå –û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞:", error);
            return { success: false, error: error.message };
        }
    },
    
    // –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    getCurrentUser() {
        return auth.currentUser;
    },
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ email
    isValidEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
    },
    
    // –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    async getUserData(uid) {
        try {
            const doc = await db.collection('users').doc(uid).get();
            if (doc.exists) {
                return { success: true, data: doc.data() };
            }
            return { success: false, error: "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω" };
        } catch (error) {
            console.error("‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö:", error);
            return { success: false, error: error.message };
        }
    },
    
    // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–¥–º–∏–Ω–∞
    async isUserAdmin(uid) {
        try {
            const doc = await db.collection('users').doc(uid).get();
            if (doc.exists) {
                const data = doc.data();
                return data.role === 'admin' || data.email === 'ziyoyunusov27@gmail.com';
            }
            return false;
        } catch (error) {
            console.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–¥–º–∏–Ω–∞:", error);
            return false;
        }
    },
    
    // –°–ª—É—à–∞—Ç–µ–ª—å –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è
    onAuthStateChanged(callback) {
        return auth.onAuthStateChanged(callback);
    }
};
        </code>
    </div>
    
    <div class="step">
        <h2>–®–∞–≥ 4: –ü—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</h2>
        <p>–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `test-auth.html` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:</p>
        <code>
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
    &lt;title&gt;–¢–µ—Å—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏&lt;/title&gt;
    &lt;script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"&gt;&lt;/script&gt;
    &lt;script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"&gt;&lt;/script&gt;
    &lt;script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"&gt;&lt;/script&gt;
    &lt;script src="firebase.js"&gt;&lt;/script&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;h2&gt;–¢–µ—Å—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏&lt;/h2&gt;
    &lt;div&gt;
        &lt;input type="email" id="test-email" placeholder="test@test.com"&gt;
        &lt;input type="password" id="test-password" placeholder="password123"&gt;
        &lt;button onclick="testLogin()"&gt;–í–æ–π—Ç–∏&lt;/button&gt;
        &lt;button onclick="testLogout()"&gt;–í—ã–π—Ç–∏&lt;/button&gt;
    &lt;/div&gt;
    &lt;div id="test-result"&gt;&lt;/div&gt;
    
    &lt;script&gt;
    function testLogin() {
        const email = document.getElementById('test-email').value;
        const password = document.getElementById('test-password').value;
        
        FirebaseAuthService.loginUser(email, password)
            .then(result => {
                document.getElementById('test-result').innerHTML = 
                    result.success ? 
                    '‚úÖ –£—Å–ø–µ—à–Ω–æ! –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ' + result.user.email : 
                    '‚ùå –û—à–∏–±–∫–∞: ' + result.error;
            });
    }
    
    function testLogout() {
        FirebaseAuthService.logout()
            .then(result => {
                document.getElementById('test-result').innerHTML = 
                    result.success ? '‚úÖ –í—ã—à–µ–ª –∏–∑ —Å–∏—Å—Ç–µ–º—ã' : '‚ùå –û—à–∏–±–∫–∞: ' + result.error;
            });
    }
    &lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;
        </code>
    </div>
    
    <script>
        function clearAllData() {
            localStorage.clear();
            sessionStorage.clear();
            alert("–î–∞–Ω–Ω—ã–µ –æ—á–∏—â–µ–Ω—ã! –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.");
        }
    </script>
</body>
</html>